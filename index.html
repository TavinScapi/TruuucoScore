<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TruuucoScore</title>

    <!-- Meta Tags e Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-title" content="TS">
    <meta name="google-site-verification" content="PuPg0kNDpVZGjIKGJW4nPzn_JVmw51N7rpTuWLsNiiI" />

    <!-- Ícones -->
    <link rel="icon" type="image/png" href="/favicon/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg">
    <link rel="shortcut icon" href="/favicon/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">

    <!-- Estilos -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="script.js" defer></script>
</head>

<body>
    <div class="screen-container">
        <header>
            <h1>Vamos jogar</h1>
            <p>Configure do seu jeito e comece!</p>
            <img src="/image/LogoTruuucoScore.png" alt="Carta de Truco" class="header-card"
                style="width: 100px; height: auto;">
        </header>

        <main>
            <section class="settings-section">
                <div class="section-header">
                    <h2>Definições do Jogo</h2>
                </div>

                <div class="settings-card-list">
                    <div class="setting-item" data-setting="Tipo de Truco">
                        <div class="item-icon-bg">
                            <i class="bi bi-calendar-event-fill"></i>
                        </div>
                        <div class="item-text">
                            <h3>Tipo de Truco</h3>
                            <p>Paulista</p>
                        </div>
                    </div>

                    <div class="setting-item" data-setting="Pontuação Máxima">
                        <div class="item-icon-bg">
                            <i class="bi bi-clipboard-data-fill"></i>
                        </div>
                        <div class="item-text">
                            <h3>Pontuação Máxima</h3>
                            <p>Atual: 12</p>
                        </div>
                    </div>

                    <div class="setting-item" data-setting="Número de Partidas">
                        <div class="item-icon-bg">
                            <i class="bi bi-trophy-fill"></i>
                        </div>
                        <div class="item-text">
                            <h3>Número de Partidas</h3>
                            <p>Melhor de 3</p>
                        </div>
                    </div>
                </div>
            </section>

            <section class="teams-section">
                <div class="section-header">
                    <h2>Equipes</h2>
                </div>

                <div class="team-cards">
                    <div class="team-card">
                        <div class="team-name">
                            <div class="item-icon-bg">
                                <i class="bi bi-flag-fill"></i>
                                <span class="team-suit" id="team-suit-nos"></span>
                            </div>
                            <span id="team-name-nos">Nós</span>
                        </div>
                        <i class="bi bi-pencil-fill edit-team" data-team="nos"></i>
                    </div>

                    <div class="team-card">
                        <div class="team-name">
                            <div class="item-icon-bg">
                                <i class="bi bi-flag-fill"></i>
                                <span class="team-suit" id="team-suit-eles"></span>
                            </div>
                            <span id="team-name-eles">Eles</span>
                        </div>
                        <i class="bi bi-pencil-fill edit-team" data-team="eles"></i>
                    </div>
                </div>
            </section>

            <div class="start-button-container">
                <button class="start-button" id="start-game">Iniciar partida</button>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="editModal">
        <div class="edit-modal">
            <div class="modal-header">
                <h2 id="modalTitle">Editar Nome da Equipe</h2>
                <button class="close-modal" id="closeModal">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <form id="teamNameForm">
                <div class="form-group">
                    <label for="teamNameInput">Nome da Equipe</label>
                    <input type="text" id="teamNameInput" class="form-input" placeholder="Digite o nome da equipe"
                        maxlength="20" required>
                </div>

                <div class="form-group">
                    <label>Escolha o Naipe</label>
                    <div class="suit-options" id="suitOptions">
                        <span class="suit-option" data-suit="♦" data-color="red">
                            <i class="bi bi-suit-diamond-fill"></i>
                        </span>
                        <span class="suit-option" data-suit="♠" data-color="black">
                            <i class="bi bi-suit-spade-fill"></i>
                        </span>
                        <span class="suit-option" data-suit="♥" data-color="red">
                            <i class="bi bi-suit-heart-fill"></i>
                        </span>
                        <span class="suit-option" data-suit="♣" data-color="black">
                            <i class="bi bi-suit-club-fill"></i>
                        </span>
                    </div>
                </div>

                <!-- Nova seção: escolha de skin -->
                <div class="form-group">
                    <label>Escolha a Skin da Carta</label>
                    <div class="skin-options" id="skinOptions">
                        <button type="button" class="skin-option" data-front="/image/padrao/frente.png" data-back="/image/padrao/verso.png" data-default="true">
                            Padrão
                        </button>
                        <button type="button" class="skin-option" data-front="/image/alternativo/frente.png" data-back="/image/alternativo/verso.png">
                            Alternativo
                        </button>

                        <!-- botão upload: abre seletor de imagens (pode selecionar 1 ou 2 imagens) -->
                        <button type="button" class="skin-option upload-option" id="uploadSkinBtn">
                            <div class="skin-preview" style="display:flex;align-items:center;justify-content:center;">
                                <i class="bi bi-image" style="font-size:1.6rem"></i>
                            </div>
                            <div class="skin-label">Upload da Galeria</div>
                        </button>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-cancel" id="cancelEdit">Cancelar</button>
                    <button type="submit" class="btn btn-save">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="pwaBanner" class="pwa-banner">
        <div class="content">
            <div class="pwa-content">
                Instale o TruuucoScore para acessar como um app!
            </div>
            <div class="list">
                <button class="muted">Recusar</button>
                <button id="installBtn" class="pwa-btn">Instalar</button>
            </div>
        </div>
    </div>

    <!-- Script local para salvar skin por time (não remove o script.js existente) -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const editButtons = document.querySelectorAll('.edit-team');
            const editModal = document.getElementById('editModal');
            const skinContainer = document.getElementById('skinOptions');
            const form = document.getElementById('teamNameForm');

            // função utilitária para criar preview/label dentro de cada .skin-option (inclui opções estáticas e dinâmicas)
            function enhanceSkinOption(opt) {
                if (opt.dataset._enhanced) return;
                const labelText = (opt.dataset.label) ? opt.dataset.label : opt.textContent.trim();
                opt.textContent = '';
                const preview = document.createElement('div');
                preview.className = 'skin-preview';
                if (opt.dataset.front) preview.style.backgroundImage = `url("${opt.dataset.front}")`;
                opt.appendChild(preview);
                const label = document.createElement('div');
                label.className = 'skin-label';
                label.textContent = labelText || 'Skin';
                opt.appendChild(label);
                opt.setAttribute('tabindex', '0');
                opt.dataset._enhanced = '1';
                if (opt.dataset.default === 'true') opt.classList.add('active');
            }

            // enhance existentes
            document.querySelectorAll('#skinOptions .skin-option').forEach(enhanceSkinOption);

            // cria input de arquivo (multiplo) escondido
            const uploadInput = document.createElement('input');
            uploadInput.type = 'file';
            uploadInput.accept = 'image/*';
            uploadInput.multiple = true;
            uploadInput.style.display = 'none';
            document.body.appendChild(uploadInput);

            // upload button action
            const uploadBtn = document.getElementById('uploadSkinBtn');
            uploadBtn.addEventListener('click', () => uploadInput.click());

            uploadInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files).slice(0, 2); // aceita 1 ou 2 (frente, verso)
                if (files.length === 0) return;
                const readers = files.map(f => new Promise((res, rej) => {
                    const r = new FileReader();
                    r.onload = () => res(r.result);
                    r.onerror = rej;
                    r.readAsDataURL(f);
                }));
                Promise.all(readers).then(urls => {
                    const frontData = urls[0];
                    const backData = urls[1] || urls[0]; // se apenas 1 arquivo, usa para frente e verso
                    // cria nova opção dinâmicamente
                    const custom = document.createElement('button');
                    custom.type = 'button';
                    custom.className = 'skin-option';
                    custom.dataset.front = frontData;
                    custom.dataset.back = backData;
                    custom.dataset.label = 'Personalizada';
                    custom.dataset.isCustom = 'true'; // marca como custom
                    // adiciona ao container antes do uploadBtn
                    skinContainer.insertBefore(custom, uploadBtn);
                    enhanceSkinOption(custom);
                    // aplicar preview — atualizar preview explicitamente
                    const prev = custom.querySelector('.skin-preview');
                    if (prev) prev.style.backgroundImage = `url("${frontData}")`;
                    // marcar como ativa
                    document.querySelectorAll('#skinOptions .skin-option').forEach(o => o.classList.remove('active'));
                    custom.classList.add('active');
                    // limpa input para permitir reupload igual arquivo depois
                    uploadInput.value = '';
                }).catch(err => {
                    console.warn('Erro ao ler imagens:', err);
                });
            });

            // seleção visual das skins (inclui opções dinâmicas)
            skinContainer.addEventListener('click', (e) => {
                const opt = e.target.closest('.skin-option');
                if (!opt) return;
                document.querySelectorAll('#skinOptions .skin-option').forEach(o => o.classList.remove('active'));
                opt.classList.add('active');
            });
            skinContainer.addEventListener('keydown', (e) => {
                const opt = e.target.closest('.skin-option');
                if (!opt) return;
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    opt.click();
                }
            });

            // Quando abrir o modal, guardamos qual time está sendo editado e marca skin salva
            editButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const team = btn.dataset.team;
                    editModal.dataset.currentTeam = team;
                    const raw = localStorage.getItem('teamSkin_' + team);
                    let activeSet = false;
                    if (raw) {
                        try {
                            const skin = JSON.parse(raw);
                            // tenta encontrar opção existente com mesmos dados
                            document.querySelectorAll('#skinOptions .skin-option').forEach(opt => {
                                if (opt.dataset.front === skin.front && opt.dataset.back === skin.back) {
                                    opt.classList.add('active');
                                    activeSet = true;
                                } else {
                                    opt.classList.remove('active');
                                }
                            });
                        } catch {}
                    }
                    if (!activeSet) {
                        const def = document.querySelector('#skinOptions .skin-option[data-default="true"]');
                        if (def) {
                            document.querySelectorAll('#skinOptions .skin-option').forEach(opt => opt.classList.remove('active'));
                            def.classList.add('active');
                        }
                    }
                });
            });

            // Ao salvar o form, grava apenas a skin escolhida no localStorage por time.
            form.addEventListener('submit', (e) => {
                const team = editModal.dataset.currentTeam;
                if (team) {
                    const active = document.querySelector('#skinOptions .skin-option.active') || document.querySelector('#skinOptions .skin-option[data-default="true"]');
                    if (active) {
                        const skin = { front: active.dataset.front, back: active.dataset.back };
                        // mantém marcação de custom se existir
                        if (active.dataset.isCustom === 'true') skin.isCustom = true;
                        localStorage.setItem('teamSkin_' + team, JSON.stringify(skin));
                    }
                }
                // deixa o restante do submit continuar (se tiver)
            });
        });
    </script>
</body>
</html>